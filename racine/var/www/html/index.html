<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>PXE server</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<style type="text/css">
			/*<![CDATA[*/
			body {
				background-color: #fff;
				color: #000;
				font-size: 0.9em;
				font-family: sans-serif,helvetica;
				margin: 0;
				padding: 0;
			}
			/*]]>*/
		</style>
	</head>

	<body>
<h1><a href="https://10.71.86.21:9090/" target="blank">Console</a></h1>
<h1>ISOs</h1>
<a href="https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-9.8.0-amd64-netinst.iso" target="blank">
https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-9.8.0-amd64-netinst.iso</a><br>
<a href="https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-9.8.0-amd64-xfce-CD-1.iso" target="blank">
https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-9.8.0-amd64-xfce-CD-1.iso</a><br>
<a href="https://cdimage.debian.org/debian-cd/current/amd64/iso-dvd/debian-9.8.0-amd64-DVD-1.iso" target="blank">
https://cdimage.debian.org/debian-cd/current/amd64/iso-dvd/debian-9.8.0-amd64-DVD-1.iso</a><br>
<a href="https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-9.8.0-amd64-mate.iso" target="blank">
https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-9.8.0-amd64-mate.iso</a><br>

<a href="http://mirrors.ircam.fr/pub/fedora/linux/releases/29/Server/x86_64/iso/Fedora-Server-netinst-x86_64-29-1.2.iso" target="blank">
http://mirrors.ircam.fr/pub/fedora/linux/releases/29/Server/x86_64/iso/Fedora-Server-netinst-x86_64-29-1.2.iso</a><br>
<a href="http://mirrors.ircam.fr/pub/fedora/linux/releases/29/Server/x86_64/iso/Fedora-Server-dvd-x86_64-29-1.2.iso" target="blank">
http://mirrors.ircam.fr/pub/fedora/linux/releases/29/Server/x86_64/iso/Fedora-Server-dvd-x86_64-29-1.2.iso</a><br>
<a href="http://mirrors.ircam.fr/pub/fedora/linux/releases/29/Workstation/x86_64/iso/Fedora-Workstation-netinst-x86_64-29-1.2.iso" target="blank">
http://mirrors.ircam.fr/pub/fedora/linux/releases/29/Workstation/x86_64/iso/Fedora-Workstation-netinst-x86_64-29-1.2.iso</a><br>
<a href="http://mirrors.ircam.fr/pub/fedora/linux/releases/29/Workstation/x86_64/iso/Fedora-Workstation-Live-x86_64-29-1.2.iso" target="blank">
http://mirrors.ircam.fr/pub/fedora/linux/releases/29/Workstation/x86_64/iso/Fedora-Workstation-Live-x86_64-29-1.2.iso</a><br>

<a href="http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-NetInstall-1810.iso" target="blank">
http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-NetInstall-1810.iso</a><br>
<a href="http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso" target="blank">
http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso</a><br>
<a href="http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-LiveGNOME-1810.iso" target="blank">
http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-LiveGNOME-1810.iso</a><br>
<a href="http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1810.iso" target="blank">
http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1810.iso</a><br>
<a href="http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-Everything-1810.iso" target="blank">
http://miroir.univ-paris13.fr/centos/7/isos/x86_64/CentOS-7-x86_64-Everything-1810.iso</a><br>

<br>

<h1>Images</h1>
<a href="http://cdimage.debian.org/cdimage/openstack/current/debian-9.8.2-20190303-openstack-amd64.qcow2" target="blank">
http://cdimage.debian.org/cdimage/openstack/current/debian-9.8.2-20190303-openstack-amd64.qcow2</a><br>
<a href="https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img" target="blank">
https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img</a><br>
<a href="http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2" target="blank">
http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2</a><br>
<a href="https://download.fedoraproject.org/pub/fedora/linux/releases/29/Cloud/x86_64/images/Fedora-Cloud-Base-29-1.2.x86_64.qcow2" target="blank">
https://download.fedoraproject.org/pub/fedora/linux/releases/29/Cloud/x86_64/images/Fedora-Cloud-Base-29-1.2.x86_64.qcow2</a><br>
<a href="http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img" target="blank">
http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img</a><br>

<br>

<h1>Links</h1>
<a href="http://www.brendangregg.com/linuxperf.html" target="blank">http://www.brendangregg.com/linuxperf.html</a><br>
<a href="http://www.n-cg.net/ncgpdf/Protocol_Poster2.pdf" target="blank">http://www.n-cg.net/ncgpdf/Protocol_Poster2.pdf</a><br>
<a href="http://packetlife.net/library/cheat-sheets/" target="blank">http://packetlife.net/library/cheat-sheets/</a><br>
<a href="https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml" target="blank">https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml</a><br>
<a href="http://www.iana.org/assignments/port-numbers" target="blank">http://www.iana.org/assignments/port-numbers</a><br>
<a href="https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml" target="blank">https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml</a><br>

<br>

<h1>Libvirt/QEMU/KVM tips</h1>
export VMNAME="testvm"<br>
export VMIP="10.71.86.101"<br>
export VMMASK="255.255.255.0"<br>
export VMMAC="52:54:00:ab:cd:ef"<br>
export VMNET="default"<br>
export VMTITLE="NAME=${VMNAME}, IP=${VMIP}/${VMMASK}, MAC=${VMMAC}, NET=${VMNET}"<br>
export VMDESC="NAME=${VMNAME}, IP=${VMIP}/${VMMASK}, MAC=${VMMAC}, NET=${VMNET}"<br>
export VMUSER="user01"<br>
export VMDOMAIN="example.com"<br>
export VMCPU=2<br>
export VMRAM=2048<br>
export VMDISK="/media/donnees/virtualisation/images/${VMNAME}/${VMNAME}.qcow2"<br>
export VMCD="/media/donnees/virtualisation/images/${VMNAME}/${VMNAME}-cidata.iso"<br>
export VMOSVARIANT="centos7.0"<br>
# list all OS variant : osinfo-query os<br>
export VMCPUMODE="host-model"<br>
# alternative : export VMCPUMODE="host-passthrough"<br>
export HYPERVISORNAME="server01"<br>
export HYPERVISORUSER="user01"<br>

<br>
mkdir /media/donnees/virtualisation/images/${VMNAME}<br>
<br>

<h1>VM Creation</h1>
# Image based<br>
virt-install \<br>
    -v \<br>
    --import --name ${VMNAME} \<br>
    --connect qemu:///system --virt-type kvm --hvm \<br>
    --metadata title="${VMTITLE}",description="${VMDESC}" \<br>
    --boot menu=on,useserial=on --serial pty \<br>
    --graphics none --video vga --sound none --controller usb,model="none" \<br>
    --cpu mode="${VMCPUMODE}" --vcpus ${VMCPU} --ram ${VMRAM} --os-type=linux --os-variant=${VMOSVARIANT} \<br>
    --disk ${VMDISK},format=qcow2,bus=virtio --disk ${VMCD},device=cdrom \<br>
    --network=network:${VMNET},model=virtio \<br>
    --noautoconsole<br>
<br>
# PXE based<br>
virt-install \<br>
    -v \<br>
    --pxe --name ${VMNAME} \<br>
    --connect qemu:///system --virt-type kvm --hvm \<br>
    --metadata title="${VMTITLE}",description="${VMDESC}" \<br>
    --boot menu=on,useserial=on --serial pty \<br>
    --graphics spice --video vga --sound none \<br>
    --cpu mode="${VMCPUMODE}" --vcpus ${VMCPU} --ram ${VMRAM} --os-type=linux --os-variant=${VMOSVARIANT} \<br>
    --disk ${VMDISK},format=qcow2,bus=virtio,cache=none \<br>
    --network=network:${VMNET},model=virtio \<br>
    --noautoconsole<br>
<br>
<h1>To Update VM Description and Title</h1>
virsh -q desc ${VMNAME} --config --live --title "${VMNAME} ${VMIP}/${VMMASK} ${VMMAC}"<br>
virsh -q desc ${VMNAME} --config --live "Network=default, IP=${VMIP}/${VMMASK}, MAC=${VMMAC}"<br>
<br>
<h1>To run on DNSmask HOST  </h1>
echo dhcp-host=${VMMAC},${VMNAME},${VMIP},72h >> /etc/dnsmasq.conf<br>
echo ${VMIP} ${VMNAME} ${VMNAME}.${VMDOMAIN} >> /etc/dnsmasq_static_hosts.conf<br>
echo ${VMIP} ${VMNAME} ${VMNAME}.${VMDOMAIN} >> /etc/hosts<br>
<br>
<h1>To send the VM a Ctrl-Alt-Del signal</h1>
virsh send-key ${VMNAME} --holdtime 1000 KEY_LEFTCTRL KEY_LEFTALT KEY_DELETE<br>
<br>
<h1>Connect to VM through SSH without certificates questions</h1>
ssh -x -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no ${VMUSER}@${VMIP}<br>
<br>
<h1>Connect to VM through the serial console</h1>
virsh console ${VMNAME} --devname serial0 --force<br>
<br>
<h1>Some Stats</h1>
virsh domid ${VMNAME} ;\<br>
virsh domuuid ${VMNAME} ;\<br>
virsh domstate ${VMNAME} ;\<br>
virsh domcontrol ${VMNAME} ;\<br>
virsh domifaddr ${VMNAME} ;\<br>
virsh dominfo ${VMNAME} ;\<br>
virsh domjobinfo ${VMNAME} ;\<br>
virsh dommemstat ${VMNAME} ;\<br>
virsh domstats ${VMNAME} ;\<br>
virsh domblklist ${VMNAME} ;\<br>
virsh domblkstat ${VMNAME} ;\<br>
virsh domblkerror ${VMNAME}<br>
<br>
<h1>Delete VM</h1>
# BE CAREFULL # virsh destroy ${VMNAME} ; virsh undefine ${VMNAME}<br>
<br>
<h1>Image creation</h1>
qemu-img create -f qcow2 /media/donnees/virtualisation/images/${VMNAME}.qcow2 20G<br>
<br>
<h1>Image resize</h1>
qemu-img resize ${VMNAME}.qcow2 +5GB<br>
<br>
<h1>Image cloning</h1>
virt-clone --original template --name debian9 --file /var/kvm/images/debian9.img<br>
<br>
<h1>URL usage</h1>
LIBVIRT_DEFAULT_URI=qemu+libssh2://${HYPERVISORUSER}@${HYPERVISORNAME}/system?known_hosts=/home/${VMUSER}/.ssh/known_hosts virsh list --all<br>
virt-viewer -c qemu+ssh://${HYPERVISORUSER}@${HYPERVISORNAME}/system ${VMNAME}<br>
<br>
<h1> mount share </h1>
modprobe 9pnet_virtio<br>
mount -t 9p -o trans=virtio,version=9p2000.L,rw monpartage /media/monpartage<br>
#<br>
# montage automatique... ne marche pas<br>
#/media/monpartage       monpartage   9p      trans=virtio,version=9p2000.L,noauto   0 0<br>
<br>
<h1>password change</h1>
# generate password :<br>
openssl passwd -1 changeme<br>
$1$QiSwNHrs$uID6S6qOifSNZKzfXsmQG1<br>
# modify it with vi through guestfish<br>
root@hypervisor # guestfish --rw -a ./${VMNAME}/${VMNAME}.qcow2<br>
><fs> run<br>
><fs> list-filesystems<br>
><fs> mount /dev/vda1 /<br>
><fs> vi /etc/shadow<br>
><fs> quit<br>
<br>
<h1>password change with virt-customize   </h1>
virt-customize --root-password password:PASSWORD<br>
<br>
<h1>virt-format</h1>
virt-format -a ./${VMNAME}/${VMNAME}.qcow2<br>
<br>
<h1>RSYNC + sparse file management</h1>
/usr/bin/rsync -avz -S -e "ssh -p 22 -q -x -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" --progress ${HYPERVISORUSER}@${HYPERVISORNAME}:/media/donnees/virtualisation/images/${VMNAME} /media/donnees/virtualisation/images/<br>
<br>
<h1>file save example</h1>
/bin/cp /etc/hosts /etc/hosts.${HOSTNAME}.`/bin/date +%Y%m%d%H%M%S`.sav<br>
<br>
<h1>SYSCTL</h1>
cat >> /etc/sysctl.conf << 'EOF'<br>
kernel.domainname = example.com<br>
kernel.hostname = pxe<br>
<br>
net.ipv4.ip_forward=1<br>
<br>
net.ipv6.conf.all.disable_ipv6 = 0<br>
net.ipv6.conf.default.disable_ipv6 = 1<br>
net.ipv6.conf.lo.disable_ipv6 = 0<br>
net.ipv6.conf.eth0.disable_ipv6 = 1<br>
EOF<br>
<br>
<h1>Boot parameters</h1>
# Fedora/Redhat/Centos<br>
root=LABEL=fpxeslash ro no_timer_check net.ifnames=0 console=tty1 console=ttyS0,115200n8 time ipv6.disable=1 apparmor=0 LANG=fr_FR.UTF-8 3<br>
# Debian<br>
root=/dev/mapper/c5sys-c5deb ro language=fr country=FR locale=fr_FR.UTF-8 time console=tty1 console=ttyS0,115200n8 kvm-intel.nested=1 intel_iommu=on ipv6.disable=1 apparmor=0<br>
<br>
<h1>ISCSI</h1>

tgtadm --lld iscsi --op new --mode target --tid 1 -T iqn.2018-12.com.example:pxe.iscsi1<br>
tgtadm --lld iscsi --op new --mode logicalunit --tid 1 --lun 1 -b /dev/vdb<br>
tgtadm --lld iscsi --op bind --mode target --tid 1 -I ALL<br>
<br>
tgtadm --lld iscsi --op show --mode target<br>
<br>
iscsiadm -m node -T 'iqn.2018-12.com.example:pxe.iscsi1' -p 10.71.86.21 -u<br>
<br>
iscsiadm --mode node --targetname iqn.2018-12.com.example:pxe.iscsi1 --portal 10.71.86.21:3260 --login<br>

	</body>
</html>
